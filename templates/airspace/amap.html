<html xmlns="http://www.w3.org/1999/xhtml"> 
  <head> 
    <title>Air Space map</title> 
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}lib/OpenLayers.js"></script> 
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/airspace.js"></script> 

    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.5.1.js"></script>

    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/flot/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/flot/jquery.flot.crosshair.js"></script>
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/flot/jquery.flot.navigate.js"></script> 
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/flot/jquery.flot.selection.js"></script> 
    <script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/flot/jquery.flot.fillbetween.js"></script> 

    <script src="{{ STATIC_URL }}js/file-upload/fileuploader.js"></script> 
    <script src="{{ STATIC_URL }}js/date.js"></script> 
 
    <link rel="stylesheet" href="{{ STATIC_URL }}style2.css" type="text/css"> 
   <link rel="stylesheet" href="{{ STATIC_URL }}style-amap.css" type="text/css"> 
    <link rel="stylesheet" href="{{STATIC_URL }}style.css" type="text/css"> 
    <link rel="stylesheet" href="{{STATIC_URL }}js/file-upload/fileuploader.css" type="text/css">

    <!-- Not 100% convinced that this is a correct way to handle
      -- CSRF with Ajax...
      -- http://stackoverflow.com/questions/5407463/how-to-use-post-with-django 
      -- seems to go this way... But still... Not 100% sure :)
      -->
    <script type="text/javascript">
      var global_csrf_token = '{{ csrf_token }}';
      var static_root = '{{ STATIC_URL }}';
    </script>

</head> 
  <body> 
        <!-- <form id="debug"><input type="submit" name"debug"/> </form> -->
	<div id="spinner-ajax-load"></div>
	<form id="name-query">
	  <input type="text" id="name-query-id" name="name-query-search" />
	  <input type="submit" name="name-query" value="Find Airspace"/>
	</form>

        <form id="debug2">
	  <input type="submit" name="debug" value="Update Visible Airspace"/>
	</form>

	<form>
	 Search radius in m for point selection (Shift+Ctrl click): <input type="text" id="radius-search" name="radius-search" value="5000" />
	</form>

	<div id="file-uploader">       
	  <noscript>          
            <p>Please enable JavaScript to use file uploader.</p>
            <!-- or put a simple form for upload here -->
	  </noscript>
	</div>

	<div id="zone_count">Zone Count:</div>

	<ul id="controlToggle"> 
            <li> 
                <input type="radio" name="type" value="none" id="noneToggle"
                       onclick="toggleControl(this);" checked="checked" /> 
                <label for="noneToggle">navigate</label> 
            </li> 
            <li> 
                <input type="radio" name="type" value="point" id="pointToggle" onclick="toggleControl(this);" /> 
                <label for="pointToggle">draw point</label> 
            </li> 
            <li> 
                <input type="radio" name="type" value="path" id="pathToggle" onclick="toggleControl(this);" /> 
                <label for="lineToggle">draw path</label> 
            </li> 
        </ul>

        <div id="map" class="smallmap"></div>

	<div id="highlighted"></div> 
	<div id="info"></div> 

        <div id="charts">
	  <div id="chart-placeholder"></div> 
	  <div id="chart-vertical"></div>
	</div> <br />

	<div id="zone-info"> </div>
 
	<script defer="defer" type="text/javascript"> 
	$('#spinner-ajax-load').hide();
	$('#spinner-ajax-load').html('<img src="{{ STATIC_URL }}img/ajax-loader.gif"/> Loading data from remote server...');
        var map = new OpenLayers.Map('map', {
	                projection: new OpenLayers.Projection("EPSG:900913"),
                        displayProjection: new OpenLayers.Projection("EPSG:4326"),
                        panMethod: OpenLayers.Easing.Quad.easeInOut,
                        panDuration: 100
	});
	
        // projection here is useless as it is applied only on objects created by the library.
        // here, we are creating the objects and then using the addFeature().
	var vectors = new OpenLayers.Layer.Vector("space", {
	        projection: new OpenLayers.Projection("EPSG:4326"),
                styleMap: styleMap,
               renderers: renderer
	});

	var path_vectors = new OpenLayers.Layer.Vector("path", {
	        projection: new OpenLayers.Projection("EPSG:4326"),
                styleMap: styleMap,
               renderers: renderer
	});


	map.addLayers([vectors, path_vectors]);

//        var wms = new OpenLayers.Layer.WMS( "OpenLayers WMS",
//            "http://vmap0.tiles.osgeo.org/wms/vmap0", {layers: 'basic'} );
 
        var osm = new OpenLayers.Layer.OSM();
	osm.setIsBaseLayer(true);
 
        map.addLayers([osm]);
//	var layerCycleMap = new OpenLayers.Layer.OSM("t@h",
//	                 "http://tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png");

	var layerCycleMap = new OpenLayers.Layer.OSM("CycleMap", "http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png");
//	var layerCycleMap = new OpenLayers.Layer.OSM("CycleMap", "http://a.thunderflames.org/tiles/cycle/${z}/${x}/${y}.png");
	map.addLayer(layerCycleMap);
 
	var layer_switcher = new OpenLayers.Control.LayerSwitcher();
	map.addControl(layer_switcher);

        var highlightCtrl = new OpenLayers.Control.SelectFeature(vectors, {
                hover: true,
                highlightOnly: true,
                renderIntent: "temporary",
            });
	map.addControl(highlightCtrl);

	var selectCtrl = new OpenLayers.Control.SelectFeature(vectors,
                {clickout: true,
	         onSelect: displayZoneInfo,
                 onUnselect: clearZoneInfo,
	        }
            );
	map.addControl(selectCtrl);

        map.addControl(new OpenLayers.Control.MousePosition());

        highlightCtrl.activate();
        layer_switcher.activate();
	selectCtrl.activate();

//	map.events.register("mousemove", map, function(e) { 
//                var position = this.events.getMousePosition(e);
//                OpenLayers.Util.getElement("coords").innerHTML = position;
//        });

        // center on Grenoble. Easier for debug :)
        map.setCenter(new OpenLayers.LonLat(5.72, 45.18).transform(map.displayProjection, map.projection), 10);
        
	$('#interload').submit(function() {
	   $.getJSON($('#interurl').val(), function(data){
	      $.each(data, function(index, inter) {
	           displayIntersection(map, inter);
	      });
	   });
	   return false;
	});
 
        $('#name-query').submit( function () {
	
            $.getJSON('/airspace/json/name/' + $('#name-query-id').val(), 
                      function(data) {
                           var i = new Array();
	                   $.each(data, function(index){
                               i.push(data[index]['pk']);
                           });
	                   getAndDisplay(vectors, i);

                      });
            return false;
        });

        $('#debug2').submit( function () {
	    $('#spinner-ajax-load').show();
            bounds = map.getExtent().transform(map.projection, map.displayProjection);
            $.getJSON('/airspace/json/bbox/id/' + bounds.toBBOX(), 
                      function(data) {
                           var i = new Array();
	                   $.each(data, function(index){
                               i.push(data[index]['pk']);
                           });
	                   getAndDisplay(vectors, i);
                      });
            return false;
        });

	// for line drawing selection
	var path_control_done = function (path) {
            path_vectors.removeAllFeatures();


            $('#spinner-ajax-load').show();
            $.post('/airspace/json/path/id/',
                   { 
                     'LS' : geojsonloader.write(path),
                     'csrfmiddlewaretoken' : global_csrf_token,
                   }, function(responseJSON) {
                     var i = new Array();
                     $.each(responseJSON.ZID, function(index){
                       i.push(responseJSON.ZID[index]['pk']);
                     });

                    // display crossed zones
                    getAndDisplay(vectors, i);

                    // handleChart(responseJSON.relief_profile, []);
                    // or trackDisplay().. But these are hardcoded for GPX track.
            });
        };
	
	// for point selection
        var pnt_control_done = function (point) {
             point.transform(map.projection, map.displayProjection);
             $('#spinner-ajax-load').show();
             $.getJSON('/airspace/json/point/id/' + point.x + ',' + point.y +',' + $('#radius-search').val(), 
                       function(data) {
                           var i = new Array();
                           $.each(data, function(index){
                                i.push(data[index]['pk']);
                           });
	                   getAndDisplay(vectors, i);
                        });
                    };


        var drawControls = {
                    point: new OpenLayers.Control.DrawFeature(path_vectors,
                               OpenLayers.Handler.Point,
	                       { "callbacks": { "done": pnt_control_done} }),
                    path: new OpenLayers.Control.DrawFeature(path_vectors,
	                        OpenLayers.Handler.Path,
                                {"callbacks": { "done": path_control_done}}),
            };
 
       for(var key in drawControls) {
             map.addControl(drawControls[key]);
       }

       $('#selected-airspace-form').submit( function () {
	    $('#spinner-ajax-load').show();
            bounds = overlay_vectors.features[0];

            $.getJSON('/airspace/json/bbox/id/' + bounds.toBBOX(), 
                      function(data) {
                           var i = new Array();
	                   $.each(data, function(index){
                               i.push(data[index]['pk']);
                           });
	                   getAndDisplay(vectors, i);
                      });
            return false;
        });

        var uploader = new qq.FileUploader( {
            action: "/airspace/json/trackup",
            element: $('#file-uploader')[0],
            multiple: false,
            onSubmit : function( id, fileName) {
               $('#spinner-ajax-load').show();
            },
            onComplete: function( id, fileName, responseJSON ) {
               if (!responseJSON.success) {
                   $('#spinner-ajax-load').hide();
                   return;
               }
               var i = new Array();
               $.each(responseJSON.ZID, function(index){
                   i.push(responseJSON.ZID[index]['pk']);
               });

               // display crossed zones
               getAndDisplay(vectors, i);

               trackDisplay(responseJSON);
            },
            params: {
               'csrf_token': global_csrf_token,
               'csrf_name': 'csrfmiddlewaretoken',
               'csrf_xname': 'X-CSRFToken',
           },
        } ) ;

	function loadAS(asid){
           $.getJSON('/airspace/json/' + asid, 
                     function(data) {
	                    displaySingleAirspace(map, data);
                     });
        };

        function toggleControl(element) {
                for(key in drawControls) {
                    var control = drawControls[key];
                    if(element.value == key && element.checked) {
                        control.activate();
                    } else {
                        control.deactivate();
                    }
                }
         }

      </script> 
 </body> 
</html> 
